flowchart TB

%% ==========================================================
%% VIDHI - MULTI AGENT ARCHITECTURE (Enterprise View)
%% ==========================================================

subgraph L0["User Interaction Layer"]
  U[ğŸ‘¤ User]
  UI[ğŸŒ Streamlit UI / Web UI]
  API[âš¡ FastAPI Gateway]
end

subgraph L1["Control & Orchestration Layer"]
  LRA[ğŸ§  LRA - Legal Reasoning Orchestrator]
  ROUTER[ğŸ”€ Task Router & Planner]
  STATE[ğŸ—‚ï¸ Session State Manager]
  POLICY[ğŸ›¡ï¸ Safety + Policy Guard]
  AUDIT[ğŸ“œ Audit & Trace Logger]
end

subgraph L2["Multi-Agent Execution Layer"]
  CLSA[ğŸ” CLSA - CaseFinder<br/>(Precedent Retrieval)]
  LII[ğŸ§© LII - IssueSpotter<br/>(Issue + Section Extraction)]
  LAA[â³ LAA - LimitationChecker<br/>(Time-bar / Limitation Rules)]
  LAB[âš”ï¸ LAB - ArgumentBuilder<br/>(Arguments + Counter Arguments)]
  DGA[ğŸ“ DGA - DocComposer<br/>(Draft Petition / Notice)]
  CCA[âœ… CCA - ComplianceGuard<br/>(Formatting + Filing Checks)]
  LAF[ğŸ¤ LAF - AidConnector<br/>(Legal Aid Suggestions)]
end

subgraph L3["Knowledge & Retrieval Layer"]
  RETR[ğŸ“Œ Hybrid Retrieval Engine<br/>(BM25 + Vector Search)]
  VDB[(ğŸ“š Vector Store<br/>Chroma / FAISS)]
  META[(ğŸ—ƒï¸ Metadata Index<br/>SQLite / JSON)]
  DOCS[(ğŸ“‚ Document Store<br/>PDF / HTML / Text)]
end

subgraph L4["Model & Tool Layer"]
  LLM[ğŸ¤– LLM Provider]
  EMB[ğŸ§  Embedding Model]
  OCR[ğŸ”  OCR Engine]
end

subgraph L5["Outputs + Human Handoff Layer"]
  PACK[ğŸ“¦ Response Packager<br/>(Answer + Citations + Drafts)]
  REPORT[ğŸ“‘ Research Summary Output]
  DRAFT[ğŸ“ƒ Draft Document Output]
  HANDOFF[ğŸ™‹ Human Review & Lawyer Validation]
end

subgraph L6["Data Ingestion Pipeline (Offline/Batch)"]
  SRC[ğŸŒ Data Sources<br/>SC / HC / Tribunals]
  ING[ğŸ•¸ï¸ Scraper + Downloader]
  PARSE[ğŸ“„ Parser + OCR]
  CLEAN[ğŸ§¼ Cleaner + Normalizer]
  CHUNK[âœ‚ï¸ Chunker]
  INDEX[ğŸ“¥ Index Builder]
end


%% ==========================================================
%% MAIN FLOW (Clean Single Pipeline)
%% ==========================================================
U --> UI --> API --> LRA
LRA --> ROUTER --> CLSA
CLSA --> RETR --> VDB
VDB --> PACK

%% ==========================================================
%% AGENT PIPELINE (Ordered Workflow)
%% ==========================================================
PACK --> LII --> LAA --> LAB --> DGA --> CCA --> LAF --> PACK

%% ==========================================================
%% GOVERNANCE & STATE (No Entanglement)
%% ==========================================================
LRA --> STATE
LRA --> POLICY
LRA --> AUDIT

%% ==========================================================
%% MODEL DEPENDENCIES (Minimal Arrows)
%% ==========================================================
RETR --> EMB
DGA --> LLM
LAB --> LLM
LII --> LLM
LAA --> LLM
CCA --> LLM

%% ==========================================================
%% FINAL OUTPUTS
%% ==========================================================
PACK --> REPORT
PACK --> DRAFT
PACK --> HANDOFF

%% ==========================================================
%% INGESTION FLOW (Separate Clean Track)
%% ==========================================================
SRC --> ING --> PARSE --> CLEAN --> CHUNK --> INDEX --> VDB
PARSE --> OCR
INDEX --> META
VDB --> DOCS
