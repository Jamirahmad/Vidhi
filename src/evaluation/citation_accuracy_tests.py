"""
Citation Accuracy Evaluation Tests

This module validates the accuracy, retrievability, and confidence
of legal citations generated by Vidhi agents.

Aligned with:
- docs/design/evaluation_strategy.md
- tests/ philosophy
- ENABLE_CITATION_VALIDATION flag
"""

from __future__ import annotations

from dataclasses import dataclass
from typing import Dict, List, Optional

from src.config.settings import get_settings
from src.utils.logging_utils import get_logger

logger = get_logger(__name__)
settings = get_settings()


# -------------------------------------------------------------------
# Data Models
# -------------------------------------------------------------------

@dataclass
class CitationResult:
    citation_text: str
    source_url: Optional[str]
    confidence_score: float
    is_retrievable: bool
    is_above_threshold: bool
    failure_reason: Optional[str] = None


@dataclass
class CitationEvaluationReport:
    total_citations: int
    valid_citations: int
    invalid_citations: int
    results: List[CitationResult]

    @property
    def accuracy(self) -> float:
        if self.total_citations == 0:
            return 0.0
        return self.valid_citations / self.total_citations


# -------------------------------------------------------------------
# Core Evaluation Logic
# -------------------------------------------------------------------

def evaluate_citations(
    citations: List[Dict[str, object]],
) -> CitationEvaluationReport:
    """
    Evaluate a list of citations produced by agents.

    Each citation dict is expected to contain:
    - citation_text (str)
    - source_url (optional str)
    - confidence_score (float)
    - retrievable (bool)
    """
    results: List[CitationResult] = []

    for citation in citations:
        try:
            citation_text = str(citation.get("citation_text", "")).strip()
            source_url = citation.get("source_url")
            confidence_score = float(citation.get("confidence_score", 0.0))
            is_retrievable = bool(citation.get("retrievable", False))

            is_above_threshold = (
                confidence_score >= settings.CITATION_CONFIDENCE_THRESHOLD
            )

            failure_reason = None
            if not citation_text:
                failure_reason = "Missing citation text"
            elif not is_retrievable:
                failure_reason = "Citation not retrievable"
            elif not is_above_threshold:
                failure_reason = "Confidence below threshold"

            result = CitationResult(
                citation_text=citation_text,
                source_url=source_url,
                confidence_score=confidence_score,
                is_retrievable=is_retrievable,
                is_above_threshold=is_above_threshold,
                failure_reason=failure_reason,
            )

            results.append(result)

        except Exception as exc:
            logger.exception("Citation evaluation failed", exc_info=exc)
            results.append(
                CitationResult(
                    citation_text=str(citation),
                    source_url=None,
                    confidence_score=0.0,
                    is_retrievable=False,
                    is_above_threshold=False,
                    failure_reason=str(exc),
                )
            )

    valid = [
        r for r in results
        if r.is_retrievable and r.is_above_threshold
    ]

    report = CitationEvaluationReport(
        total_citations=len(results),
        valid_citations=len(valid),
        invalid_citations=len(results) - len(valid),
        results=results,
    )

    _log_report(report)
    return report


# -------------------------------------------------------------------
# Logging & Observability
# -------------------------------------------------------------------

def _log_report(report: CitationEvaluationReport) -> None:
    """
    Log a summary of the citation evaluation.
    """
    logger.info(
        "Citation Evaluation Completed | "
        "Total=%s | Valid=%s | Invalid=%s | Accuracy=%.2f",
        report.total_citations,
        report.valid_citations,
        report.invalid_citations,
        report.accuracy,
    )

    for result in report.results:
        if result.failure_reason:
            logger.warning(
                "Citation failed | reason=%s | citation=%s",
                result.failure_reason,
                result.citation_text,
            )
